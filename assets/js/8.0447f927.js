(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{212:function(s,t,n){"use strict";n.r(t);var a=n(28),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"使用-session-get-tasks-方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-session-get-tasks-方法"}},[s._v("#")]),s._v(" 使用 Session.get_tasks 方法")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),n("p",[s._v("本方法仅适用于旧 "),n("code",[s._v("Session")]),s._v(", 新的 "),n("code",[s._v("Application")]),s._v(" 可以通过在运行方法 "),n("code",[s._v("Mirai.run")]),s._v(" 时,\n传入具名形参 "),n("code",[s._v("loop")]),s._v(" 以使业务在已有的事件循环内运行.")])]),s._v(" "),n("p",[s._v("默认情况下, 为了保证短轮询和 "),n("code",[s._v("event_runner")]),s._v(" 的数据共享,\n我们通常在程序内部新建立一个单独的线程来执行此种操作,\n并要求您使用 "),n("code",[s._v("Session.joinMainThread")]),s._v(" 方法堵塞主线程以保证程序的运行.")]),s._v(" "),n("p",[s._v("但这只是推荐方法, 若你具有特殊的需求,\n需要将 "),n("code",[s._v("python-mirai")]),s._v(" 作为库而不是运行时环境使用,\n我们也有相应的解决方案.")]),s._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),n("p",[s._v("通常情况下, 默认方式就已经足够好用,\n接下来的操作要求您熟悉 Python 标准库 "),n("code",[s._v("asyncio")]),s._v(" 的用法."),n("br"),s._v("\n若你对接下来的操作感到迷惑, 可以暂时跳过此段.")])]),s._v(" "),n("h2",{attrs:{id:"不使用-async-with"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#不使用-async-with"}},[s._v("#")]),s._v(' 不使用 "async with"')]),s._v(" "),n("p",[s._v("在这种方式中, 你需要自己启动短轮询协程和 "),n("code",[s._v("event_runner")]),s._v("."),n("br"),s._v("\n同时, 你需要手动实例化一个 "),n("code",[s._v("asyncio.Queue")]),s._v(", 并将其设置为 "),n("code",[s._v("Session.event_stack")]),s._v(" 的值:")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mirai "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Session\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n\nauthKey "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"this-is-a-authkey"')]),s._v("\nqq "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("183213564")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    session "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string-interpolation"}},[n("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"mirai://localhost:8080/?authKey=')]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("authKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("&qq=")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("qq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("event_stack "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" asyncio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Queue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\nasyncio"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("然后使用 "),n("code",[s._v("Session.get_tasks")]),s._v(" 和 "),n("code",[s._v("Session.enable_session")]),s._v(":")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" Session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("enable_session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("与之前的区别在于: 我们使用了运行在主线程的事件循环启动了短轮询协程和 "),n("code",[s._v("event_runner")]),s._v(",\n这种方式便于与现有的系统一起运作, 具有低侵入性.")]),s._v(" "),n("h2",{attrs:{id:"关闭"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关闭"}},[s._v("#")]),s._v(" 关闭")]),s._v(" "),n("p",[s._v("不幸的是, 不使用 "),n("code",[s._v("async with")]),s._v(" 意味着你需要自己实现一套的合理退出方案:")]),s._v(" "),n("ul",[n("li",[s._v("设置 "),n("code",[s._v("Session.exit_signal")]),s._v(" 的值为 "),n("code",[s._v("True")])]),s._v(" "),n("li",[s._v("你需要调用 "),n("code",[s._v("Session.close_session")]),s._v(" 来使当前使用的 "),n("code",[s._v("sessionKey")]),s._v(" 被释放. 若不释放会导致无头客户端一定量的内存泄漏.")])])])}),[],!1,null,null,null);t.default=e.exports}}]);