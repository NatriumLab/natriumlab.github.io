(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{220:function(s,t,a){"use strict";a.r(t);var n=a(28),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"依赖注入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#依赖注入"}},[s._v("#")]),s._v(" 依赖注入")]),s._v(" "),a("p",[a("code",[s._v("python-mirai")]),s._v(" 有着非常强大但又十分简单的"),a("strong",[s._v("依赖注入")]),s._v("机制.")]),s._v(" "),a("p",[s._v("它的设计非常简单, 使任何开发人员都很容易将其他组件与 "),a("code",[s._v("python-mirai")]),s._v(" 集成.")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("如果你了解过 "),a("a",{attrs:{href:"https://fastapi.tiangolo.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Fastapi"),a("OutboundLink")],1),s._v(",\n你会发现这几乎和 Fastapi 的依赖注入机制是从一个模子里刻出来的..."),a("br"),s._v("\n是的, 我们在设计这个框架时, 借鉴, 模仿了流行框架的一些设计,\n以帮助开发者更好的进行开发.")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[a("code",[s._v("Application")]),s._v(" 机制完全兼容本特性.")])]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),a("p",[s._v("不同于 Annotations 特性, 目前依赖注入"),a("strong",[s._v("不进行")]),s._v("启动时检查,\n这意味着你需要有足够的经验才能尽量少的抛出错误..?")]),s._v(" "),a("p",[a("code",[s._v("Application")]),s._v(" 机制已在开发分支加入对依赖注入的启动时检查,\n且会在可预见的未来进行向后迁移.")])]),s._v(" "),a("h2",{attrs:{id:"什么是-依赖注入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-依赖注入"}},[s._v("#")]),s._v(' 什么是 "依赖注入"?')]),s._v(" "),a("p",[s._v('"依赖注入" 是指在编写程序的过程中的一种让代码声明需要用于工作和使用的东西 —— 即"依赖项" —— 的方法.')]),s._v(" "),a("p",[s._v('负责处理声明的依赖注入的系统将负责处理一切需要执行的工作, 以提供业务代码需要使用的 "依赖项",\n这个过程称为 "注入".')]),s._v(" "),a("p",[s._v("当你需要做类似这些事情时:")]),s._v(" "),a("ul",[a("li",[s._v("重用代码逻辑")]),s._v(" "),a("li",[s._v("共享数据库会话")]),s._v(" "),a("li",[s._v("强制对上下文进行验证(用户身份验证)")]),s._v(" "),a("li",[s._v("还有很多...")])]),s._v(" "),a("p",[s._v("依赖注入机制能帮助重用代码逻辑, 减少代码量, 使开发者能更加专注于业务的逻辑.")]),s._v(" "),a("h2",{attrs:{id:"第一步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一步"}},[s._v("#")]),s._v(" 第一步")]),s._v(" "),a("p",[s._v("通过一个简单的实例来窥探事物一角, 是从零开始了解事务的一条较为轻松的途径.")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mirai "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Depend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Plain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" MessageChain\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" asyncio\n\nauthKey "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"213we355gdfbaerg"')]),s._v("\nqq "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("208924405")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("depend_test_func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" MessageChain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("toString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" Session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"mirai://localhost:8070/?authKey=')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("authKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("&qq=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("qq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("receiver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"FriendMessage"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fm_test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Depend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("depend_test_func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("joinMainThread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n\nasyncio"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("执行这段代码后, 给机器人发送一段信息, 控制台会输出信息的内容.")]),s._v(" "),a("p",[s._v("刚才, 我们并没有在事件主体内调用 "),a("code",[s._v("toString")]),s._v(" 方法, 而是在 "),a("code",[s._v("depend_test_func")]),s._v("\n内执行并返回了 "),a("code",[s._v("toString")]),s._v(" 方法返回的值, 然后事件主体内部被传入的参数 "),a("code",[s._v("message")]),s._v(" 就是函数\n"),a("code",[s._v("depend_test_func")]),s._v(" 的返回值.")]),s._v(" "),a("h2",{attrs:{id:"发生了什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#发生了什么"}},[s._v("#")]),s._v(" 发生了什么?")]),s._v(" "),a("p",[a("code",[s._v("python-mirai")]),s._v(" 的内部机制检测到你在事件主体内定义了一个依赖注入项, 先执行了该依赖注入项,\n捕获返回值后与其他参数一起传入到了事件主体内.")]),s._v(" "),a("h2",{attrs:{id:"嵌套依赖注入-nested"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#嵌套依赖注入-nested"}},[s._v("#")]),s._v(" 嵌套依赖注入(Nested)")]),s._v(" "),a("p",[s._v("我们的机制允许你注入近乎无限个的依赖注入项, 并且也容许在依赖注入内使用依赖注入项:")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("depend1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("depend2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("d1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Depend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("depend1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" d1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);